<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>합치다 보니 신이되었다 | Index</title>

    <!-- 리소스 프리로드 -->
    <link rel="preload" as="image" href="images/title.png">
    <link rel="preload" as="image" href="images/start_btn.png">
    <link rel="preload" as="audio" href="sounds/mainmap_bgm.mp3">

    <style>
        :root {
            --btn-offset-y: 200px;
            --btn-max-width: 202px;
            --sheet-bg: rgba(8,12,18,.84);
            --card-bg: rgba(18,24,32,.9);
            --fg: #e8f0ff;
            --muted: #9fb0c7;
            --accent: #46d3ff;
            --ok: #67ff9a;
            --warn: #ffcc4d;
            --err: #ff6b6b;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            margin: 0;
            background: #000;
            overflow: hidden;
            font-family: system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Arial,sans-serif;
            color: var(--fg);
        }

            body.fade-out {
                transition: opacity .6s ease;
                opacity: 0;
            }

        #indexScreen {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
            background: url("images/title.png") center/cover no-repeat;
        }

        .centerStack {
            position: relative;
            display: grid;
            place-items: center;
            width: 100%;
            height: 100%;
        }

        #startBtn {
            position: relative;
            transform: translateY(var(--btn-offset-y));
            width: min(56vw,var(--btn-max-width));
            aspect-ratio: 3/1;
            background: url("images/start_btn.png") center/contain no-repeat;
            border: none;
            cursor: pointer;
            filter: drop-shadow(0 8px 18px rgba(0,0,0,.55));
            transition: transform .08s ease;
        }

            #startBtn:active {
                transform: translateY(calc(var(--btn-offset-y) + 2px)) scale(.98);
            }

        .sr-only {
            position: absolute !important;
            width: 1px;
            height: 1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
        }

        /* 좌상단 버튼 */
        #rankOpenBtn, #tipOpenBtn {
            position: fixed;
            left: 14px;
            z-index: 6;
            height: 48px;
            padding: 0 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.4);
            color: var(--fg);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            cursor: pointer;
        }

        #rankOpenBtn {
            top: 14px;
        }

        #tipOpenBtn {
            top: 70px;
        }

        #rankOpenBtn .badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(70,211,255,.2);
            color: var(--accent);
            border: 1px solid rgba(70,211,255,.35);
        }

        /* 우상단 ID */
        #idBadge {
            position: fixed;
            right: 14px;
            top: 14px;
            z-index: 6;
            height: 48px;
            max-width: min(70vw,560px);
            padding: 0 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.42);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
        }

            #idBadge .label {
                color: var(--muted);
                font-weight: 700;
                font-size: 12px;
            }

            #idBadge .edit {
                margin-left: auto;
                padding: 6px 10px;
                border-radius: 999px;
                cursor: pointer;
                border: 1px solid rgba(255,255,255,.14);
                background: rgba(255,255,255,.06);
                font-size: 12px;
                color: #fff; /* 화이트 폰트 */
            }

        /* 공통 모달/시트 */
        .modal-backdrop, .sheet-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            z-index: 10; /* 랭킹창 아래로 내려줌 */
            opacity: 0;
            pointer-events: none;
            transition: .2s;
        }

            .modal-backdrop.open, .sheet-backdrop.open {
                opacity: 1;
                pointer-events: auto;
            }

        .modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%,-50%) scale(.98);
            z-index: 21;
            width: min(92vw,520px);
            background: var(--sheet-bg);
            border: 1px solid rgba(255,255,255,.18);
            border-radius: 16px;
            opacity: 0;
            pointer-events: none;
            transition: .2s;
        }

            .modal.open {
                opacity: 1;
                pointer-events: auto;
                transform: translate(-50%,-50%) scale(1);
            }

            .modal .hd {
                padding: 14px 16px 8px;
                text-align: center;
                font-weight: 900;
                font-size: 18px;
            }

            .modal .body {
                padding: 0 16px 16px;
                text-align: center;
            }

            .modal .ft {
                padding: 12px 16px 16px;
                text-align: center;
            }

        .btn {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.18);
            background: rgba(255,255,255,.08);
            color: var(--fg);
            font-weight: 800;
            cursor: pointer;
        }

            .btn.ok {
                background: rgba(103,255,154,.14);
                border-color: rgba(103,255,154,.5);
            }

        /* 시트 (랭킹) */
        .sheet {
            position: fixed;
            inset: auto 0 0 0;
            z-index: 20; /* 딤드보다 위로 올림 */
    background: var(--sheet-bg);
            background: var(--sheet-bg);
            border-radius: 18px 18px 0 0;
            transform: translateY(100%);
            transition: .28s;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -12px 28px rgba(0,0,0,.35);
            backdrop-filter: blur(10px);
        }

            .sheet.open {
                transform: translateY(0);
            }

        .sheet-header {
            position: relative;
            padding: 14px 16px 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sheet-title {
            font-weight: 800;
            font-size: 18px;
            letter-spacing: .2px;
        }

        .sheet-sub {
            color: var(--muted);
            font-size: 12px;
        }

        .sheet-close {
            position: absolute;
            right: 10px;
            top: 10px;
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            background: rgba(255,255,255,.12);
            border: 2px solid rgba(255,255,255,.95);
            color: #fff;
            font-size: 22px;
            font-weight: 900;
            cursor: pointer;
        }

        .pill-tabs {
            display: flex;
            gap: 8px;
            padding: 0 16px 12px;
            flex-wrap: wrap;
        }

        .pill {
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.1);
            color: var(--muted);
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
        }

            .pill.active {
                color: var(--accent);
                border-color: rgba(70,211,255,.4);
                background: rgba(70,211,255,.08);
            }

        .sheet-body {
            min-height: 200px;
            overflow: auto;
            padding: 0 16px 20px;
        }

        .today-card {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 16px;
            padding: 14px;
            margin: 0 0 14px;
            display: grid;
            gap: 10px;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .date-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.1);
            color: #cfe2ff;
        }

        .big-id {
            font-weight: 900;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
        }

        .score {
            font-weight: 800;
            color: #9affc0;
            font-variant-numeric: tabular-nums;
        }

        .note {
            color: var(--muted);
            font-size: 12px;
        }

        .list {
            display: grid;
            gap: 10px;
        }

        .item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            background: rgba(255,255,255,.04);
            border: 1px solid rgba(255,255,255,.08);
            padding: 10px 12px;
            border-radius: 12px;
        }

            .item .left {
                min-width: 0;
                display: grid;
                gap: 2px;
            }

            .item .date {
                font-size: 12px;
                color: #cde0ff;
            }

            .item .pid {
                font-weight: 800;
                display: flex;
                align-items: center;
                gap: 8px;
                overflow: hidden;
            }

            .item .rscore {
                font-weight: 800;
                color: #96ffc0;
                font-variant-numeric: tabular-nums;
            }

        .medal {
            width: 18px;
            aspect-ratio: 1/1;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,.35));
        }

        .empty {
            padding: 14px;
            text-align: center;
            color: var(--muted);
            border: 1px dashed rgba(255,255,255,.15);
            background: rgba(255,255,255,.03);
            border-radius: 12px;
        }

        .safe-bottom {
            height: max(12px,env(safe-area-inset-bottom));
        }
    </style>
</head>
<body>
    <noscript>이 게임을 실행하려면 JavaScript가 필요합니다.</noscript>

    <div id="indexScreen">
        <button id="rankOpenBtn"><span>🏆 랭킹</span><span class="badge">Daily</span></button>
        <button id="tipOpenBtn"><span>🎮 게임 팁</span></button>
        <div id="idBadge">
            <span class="label">현재 ID</span><span class="pid" id="currentId">—</span>
            <button class="edit" id="editIdBtn">✏️ Edit</button>
        </div>
        <div class="centerStack"><button id="startBtn"><span class="sr-only">START</span></button></div>
    </div>

    <!-- 랭킹 시트 -->
    <div id="sheetBackdrop" class="sheet-backdrop"></div>
    <section id="rankSheet" class="sheet">
        <header class="sheet-header">
            <div>
                <div class="sheet-title">일일 TOP</div>
                <div class="sheet-sub">하루 1명(최고 점수) · 날짜별 열람</div>
            </div>
            <button class="sheet-close" id="sheetClose">✕</button>
        </header>
        <nav class="pill-tabs">
            <div class="pill active" data-tab="today">오늘</div>
            <div class="pill" data-tab="bydate">날짜별</div>
        </nav>
        <div class="sheet-body">
            <div id="tab-today">
                <div class="today-card">
                    <div class="row">
                        <span class="date-badge" id="todayBadge">—</span>
                        <span class="score" id="todayScore"></span>
                    </div>
                    <div class="big-id" id="todayId">불러오는중...</div>
                    <div class="note">플레이 유도 코멘트, 혹은 공지사항</div>
                </div>
            </div>
            <div id="tab-bydate" style="display:none">
                <div class="list" id="dateList"></div>
                <div class="safe-bottom"></div>
            </div>
        </div>
    </section>

    <!-- 팁 모달 -->
    <div id="tipModalBackdrop" class="modal-backdrop"></div>
    <section id="tipModal" class="modal">
        <div class="hd">게임 팁</div>
        <div class="body">
            <p>이 게임은 더 이상 이동할 블럭이 없을 때 종료됩니다.</p>
            <p>4개 이상을 모아도 3개만 합쳐집니다.</p>
            <p>최대한 비효율적으로 운영하면서 생존해보세요.</p>
        </div>
        <div class="ft"><button id="tipCloseBtn" class="btn ok">확인</button></div>
    </section>

    <audio id="bgm" src="sounds/mainmap_bgm.mp3" preload="auto" loop></audio>

    <script>
        const bgm = document.getElementById('bgm'),
            startBtn = document.getElementById('startBtn');
        const tipOpenBtn = document.getElementById('tipOpenBtn'),
            tipModal = document.getElementById('tipModal'),
            tipModalBackdrop = document.getElementById('tipModalBackdrop'),
            tipCloseBtn = document.getElementById('tipCloseBtn');
        const currentIdEl = document.getElementById('currentId'),
            editIdBtn = document.getElementById('editIdBtn');

        /* ===== ID 저장 ===== */
        const PID_KEY = "mergePlayerId";
        function getPID() { return (localStorage.getItem(PID_KEY) || "").trim(); }
        function setPID(v) { const t = String(v || "").trim(); if (!t) return; localStorage.setItem(PID_KEY, t); refreshIdBadge(); }
        function refreshIdBadge() { currentIdEl.textContent = getPID() || '미설정'; }

        /* ===== 팁 모달 ===== */
        function openTipModal() { tipModal.classList.add('open'); tipModalBackdrop.classList.add('open'); }
        function closeTipModal() { tipModal.classList.remove('open'); tipModalBackdrop.classList.remove('open'); }
        tipOpenBtn.addEventListener('click', openTipModal);
        tipCloseBtn.addEventListener('click', closeTipModal);
        tipModalBackdrop.addEventListener('click', closeTipModal);
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTipModal(); });

        /* ===== ID 입력 ===== */
        function openIdModal(force = false) {
            let pid = getPID();
            if (!pid || force) {
                let input = "";
                while (!input) {
                    input = prompt("플레이어 아이디를 입력하세요:");
                    if (input === null) break;
                    input = input.trim();
                }
                if (input) setPID(input);
            }
        }
        editIdBtn.addEventListener('click', () => openIdModal(true));

        /* ===== 랭킹 ===== */
        const rankOpenBtn = document.getElementById('rankOpenBtn');
        const sheet = document.getElementById('rankSheet'),
            backdrop = document.getElementById('sheetBackdrop'),
            sheetClose = document.getElementById('sheetClose');
        const pills = Array.from(document.querySelectorAll('.pill')),
            tabToday = document.getElementById('tab-today'),
            tabByDate = document.getElementById('tab-bydate');
        const todayBadge = document.getElementById('todayBadge'),
            todayId = document.getElementById('todayId'),
            todayScore = document.getElementById('todayScore'),
            dateList = document.getElementById('dateList');

        const RANK_API = 'https://script.google.com/macros/s/AKfycbwIJmiCseB5UAQjfTIKN_812VkvXdLqmTObnq01JGxJV6D3T5TzKdsrU26_qbxQGGPq/exec';

        function openSheet() { backdrop.classList.add('open'); sheet.classList.add('open'); }
        function closeSheet() { sheet.classList.remove('open'); backdrop.classList.remove('open'); }
        rankOpenBtn.addEventListener('click', openSheet);
        sheetClose.addEventListener('click', closeSheet);
        backdrop.addEventListener('click', closeSheet);
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeSheet(); });

        pills.forEach(p => p.addEventListener('click', () => {
            pills.forEach(x => x.classList.remove('active'));
            p.classList.add('active');
            const tab = p.dataset.tab;
            tabToday.style.display = (tab === 'today') ? '' : 'none';
            tabByDate.style.display = (tab === 'bydate') ? '' : 'none';
        }));

        const tz = 'Asia/Seoul';
        function todayStr() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
        function fmtK(dateStr) { const d = new Date(dateStr + 'T00:00:00'); return new Intl.DateTimeFormat('ko-KR', { dateStyle: 'medium', timeZone: tz }).format(d); }
        function number(n) { return new Intl.NumberFormat('ko-KR').format(n); }
        function esc(s = '') { return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
        const CROWN_SVG = `<svg class="medal" viewBox="0 0 24 24"><defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="#FFD95A"/><stop offset="1" stop-color="#FFB200"/></linearGradient></defs><path fill="url(#g)" d="M4 8l4 3 4-6 4 6 4-3v9a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V8z"/><rect x="5" y="16" width="14" height="3" rx="1" fill="rgba(255,255,255,.35)"/></svg>`;

        function buildRecentDays(n = 30) { const arr = [], base = new Date(); for (let i = 0; i < n; i++) { const d = new Date(base); d.setDate(base.getDate() - i); arr.push({ date: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`, id: null, score: null }); } return arr; }
        async function fetchDailyTop(limit = 60) { const res = await fetch(`${RANK_API}?mode=dailyTop&limit=${limit}`, { cache: 'no-store' }); const json = await res.json(); return Array.isArray(json.data) ? json.data : []; }
        function renderToday(map) { const t = todayStr(), r = map.get(t); todayBadge.textContent = fmtK(t); if (r && r.id) { todayId.innerHTML = `${CROWN_SVG}<span>${esc(r.id)}</span>`; todayScore.textContent = r.score ? `${number(r.score)}점` : ''; } else { todayId.textContent = '기록 없음'; todayScore.textContent = ''; } }
        function renderDateList(rows) { dateList.innerHTML = ''; if (!rows.length) { dateList.innerHTML = '<div class="empty">기록이 없습니다.</div>'; return; } const f = document.createDocumentFragment(); rows.forEach(r => { const el = document.createElement('div'); el.className = 'item'; el.innerHTML = `<div class="left"><div class="date">${fmtK(r.date)}</div><div class="pid">${r.id ? CROWN_SVG + '<span>' + esc(r.id) + '</span>' : '—'}</div></div><div class="rscore">${r.score ? number(r.score) : ''}</div>`; f.appendChild(el); }); dateList.appendChild(f); }
        async function loadRanking() { const base = buildRecentDays(60), map = new Map(base.map(r => [r.date, r])); try { const apiRows = await fetchDailyTop(60); apiRows.forEach(x => { const d = x.date?.slice(0, 10); if (!d) return; if (map.has(d)) { const t = map.get(d); t.id = x.id || t.id; t.score = parseInt(x.score || '') || null; } else { map.set(d, { date: d, id: x.id || null, score: x.score || null }); } }); } catch (e) { console.warn('랭킹 로드 실패:', e); } renderToday(map); renderDateList(Array.from(map.values()).sort((a, b) => a.date < b.date ? 1 : -1)); }

        /* ===== START ===== */
        startBtn.addEventListener('click', () => {
            document.body.classList.add('fade-out');
            setTimeout(() => { window.location.href = "game.html"; }, 400);
        });

        /* ===== 초기 ===== */
        window.addEventListener('load', () => {
            refreshIdBadge();
            if (!getPID()) {
                openIdModal(true);
                const chk = setInterval(() => {
                    if (getPID()) { clearInterval(chk); openSheet(); loadRanking(); }
                }, 300);
            } else {
                openSheet();
                loadRanking();
            }
        });
        /* ===== BGM 자동 재생 (모든 유저 입력에 반응) ===== */
        let bgmStarted = false;

        function tryPlayBGM() {
            if (bgmStarted) return;
            bgmStarted = true;
            bgm.volume = 0.6;

            const playPromise = bgm.play();
            if (playPromise !== undefined) {
                playPromise
                    .then(() => console.log('BGM 재생 시작'))
                    .catch(err => {
                        console.warn('자동재생 차단됨, 재시도 대기:', err);
                        // 일부 브라우저는 첫 play() 실패 시 다시 시도해야 함
                        document.addEventListener('pointerdown', forcePlayBGM, { once: true });
                        document.addEventListener('touchstart', forcePlayBGM, { once: true });
                        document.addEventListener('click', forcePlayBGM, { once: true });
                    });
            }
        }

        function forcePlayBGM() {
            bgm.play().then(() => console.log('BGM 재시작 성공')).catch(() => { });
        }

        /* 모든 입력에 반응하도록 */
        ['click', 'touchstart', 'pointerdown', 'keydown'].forEach(evt => {
            window.addEventListener(evt, tryPlayBGM, { once: true });
        });

    </script>
</body>
</html>
